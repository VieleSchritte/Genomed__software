{% extends "../base.html" %}

{% block html_title %}
    {{ block.super }} — Cognation
{% endblock %}

{% block title %}
    Cognation
{% endblock title %}

{% block content %}
    {{ block.super }}
    <form action="{% url 'cognation:calculate' %}" method="post" id="cognationForm" class="text-dark">
        <div class="wrapper">
            {% load static %}
            <div id="select-formula">
                <div class="but-bunch" data-toggle="buttons">
                    <h1 id="start-header">Выберите тип родства:</h1>
                    <div id="cognation-screen" class="choose-cognation">
                        {% for formula in formulas %}
                        <label class="cognation-button" title="{{ formula.name }}">
                            <input
                                    type="radio"
                                    class="target"
                                    value="{{ formula.value }}"
                                    name="type"
                                    data-image-url="{% static formula.image %}"/> {{ formula.name }}
                        </label>
                        {% endfor %}
                    </div>

                    <div id="cognation-preview" class="cognation-preview">
                        <h2 class="preview-header"></h2>
                        <img class="preview-image" src="" alt="">
                        <div class="text-buttons">
                            <p class="preview-text"></p>
                            <div class="preview-buttons">
                                <label id="back-button-preview" class="preview-button">
                                    <input type="button" value="Назад">Назад
                                </label>
                                <label id="next-button-preview" class="preview-button">
                                    <input type="button" value="OK">OK
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="add-genotype" class="add-genotype">
                        <h2 class="genotype-header"></h2>
                        <label for="part{{ forloop.counter }}Id"></label>
                            <textarea name="part{{ forloop.counter }}" id="part{{ forloop.counter }}Id" cols="120" rows="24" class="form-control"></textarea>
                        {% csrf_token %}
                        <div class="genotype-buttons">
                            <label id="back-button-genotype" class="genotype-button">
                                <input type="button" value="Назад">Назад
                            </label>
                            <label id="next-button-genotype" class="genotype-button">
                                <input type="button" value="Далее">Далее
                            </label>
                            <button id="submit-button" class="genotype-button submit">
                                Рассчитать
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <script>
            let formulas = {{ formulas_dump|safe }};

            const STEP_CHOOSE_COGNATION = 'choose_cognation';
            const STEP_COGNATION_PREVIEW = 'cognation_preview';
            const STEP_FILL_IN_DATA = 'fill_in_data';

            let value = 0;
            let currentFormula = '';

            let step = STEP_CHOOSE_COGNATION;
            let fillInPart = 0;
            let data = [];

            function HideCognationScreen() {
                let cognationScreen = document.getElementById('cognation-screen');
                let startHeader = document.getElementById('start-header');
                cognationScreen.style.display = 'none';
                startHeader.style.display = 'none';
            }

            function ShowCognationScreen() {
                let cognationScreen = document.getElementById('cognation-screen');
                let startHeader = document.getElementById('start-header');
                cognationScreen.style.display = 'block';
                startHeader.style.display = 'block';
            }

            function HideCognationPreview() {
                let cognationPreview = document.getElementById('cognation-preview');
                cognationPreview.style.display = 'none'
            }

            function ShowCognationPreview() {
                let cognationPreview = document.getElementById('cognation-preview');
                cognationPreview.style.display = 'block';
            }

            function HideAddGenotype() {
                let addGenotype = document.getElementById('add-genotype');
                addGenotype.style.display = 'none';
            }

            function ShowAddGenotype() {
                let addGenotype = document.getElementById('add-genotype');
                addGenotype.style.display = 'block';
            }

            function HideNextButton() {
                let nextButton = document.getElementById('next-button-genotype');
                nextButton.style.display = 'none';
            }

            function ShowNextButton() {
                let nextButton = document.getElementById('next-button-genotype');
                nextButton.style.display = 'inline-block';
            }

            function HideSubmitButton() {
                let submitButton = document.getElementById('submit-button');
                submitButton.style.display = 'none';
            }

            function ShowSubmitButton() {
                let submitButton = document.getElementById('submit-button');
                submitButton.style.display = 'inline-block';
            }

            function AddGenotypeProcessing() {
                let addGenotype = document.getElementById('add-genotype');
                let currentHeader = addGenotype.querySelector('h2');
                let headersList = currentFormula['headers'];
                let labelOnText = addGenotype.querySelector('label');
                let textarea = labelOnText.nextElementSibling;

                currentHeader.innerHTML = headersList[fillInPart - 1];
                labelOnText.setAttribute('for', 'part' + String(fillInPart));
                textarea.setAttribute('id', 'part' + String(fillInPart));
                textarea.setAttribute('name', 'part' + String(fillInPart));
            }

            function OnRadioClick(event) {
                if (this !== event.target) {
                    return
                }
                step = STEP_COGNATION_PREVIEW;
                let label = event.target;
                let input = label.querySelector('input');
                value = Number(input.getAttribute('value'));
                let imageUrl = input.getAttribute('data-image-url');
                currentFormula = formulas.find((f) => f['value'] === value);

                let cognationPreview = document.getElementById('cognation-preview');
                cognationPreview.querySelector('.preview-header').innerHTML = currentFormula['name'];
                let imageForm = cognationPreview.querySelector('.preview-image');
                imageForm.setAttribute('src', imageUrl);
                imageForm.setAttribute('alt', currentFormula['name']);
                let previewText = cognationPreview.querySelector('.preview-text');
                previewText.innerHTML = currentFormula['desc'];
                HideCognationScreen();
                HideSubmitButton();
                ShowCognationPreview();
            }

            /* behaviour of RadioButtons */
            window.onload = function setUpHandlers() {
                for (let label of document.querySelectorAll('label.cognation-button')) {
                    label.addEventListener("click", OnRadioClick);
                }
            }

            function OnBackClick(event) {
                if (this !== event.target) {
                    return
                }

                if (step === STEP_COGNATION_PREVIEW) {
                    step = STEP_CHOOSE_COGNATION;
                    value = 0;
                    currentFormula = '';
                    HideCognationPreview();
                    ShowCognationScreen();
                }
                let participants_number = currentFormula['participants_number'];

                if (step === STEP_FILL_IN_DATA) {
                    if (fillInPart === 1) {
                        fillInPart--;
                        step = STEP_COGNATION_PREVIEW;
                        HideAddGenotype();
                        ShowCognationPreview();
                    } else if (fillInPart < participants_number && fillInPart > 1) {
                        fillInPart--;
                        AddGenotypeProcessing();
                        ShowAddGenotype();
                    } else if (fillInPart === participants_number) {
                        fillInPart--;
                        AddGenotypeProcessing();
                        ShowAddGenotype();
                        HideSubmitButton();
                        ShowNextButton();
                    }
                }
            }

            let previewBackButton = document.getElementById('back-button-preview');
            previewBackButton.addEventListener('click', OnBackClick);
            let backButtonGenotype = document.getElementById('back-button-genotype');
            backButtonGenotype.addEventListener('click', OnBackClick);

            function OnNextClick(event) {
                if (this !== event.target) {
                    return
                }
                fillInPart++;
                let participants_number = currentFormula['participants_number'];
                AddGenotypeProcessing();

                if (step === STEP_COGNATION_PREVIEW) {
                    step = STEP_FILL_IN_DATA;
                    HideCognationPreview();
                    HideSubmitButton();
                    ShowNextButton();
                    ShowAddGenotype();

                } else if (step === STEP_FILL_IN_DATA) {
                    if (fillInPart === participants_number) {
                        ShowAddGenotype();
                        HideNextButton();
                        ShowSubmitButton();

                    } else {
                        ShowNextButton();
                    }
                }
            }

            let previewNextButton = document.getElementById('next-button-preview');
            previewNextButton.addEventListener("click", OnNextClick, {capture:true});
            let nextButtonGenotype = document.getElementById('next-button-genotype');
            nextButtonGenotype.addEventListener("click", OnNextClick, {capture:true});

        </script>
    </form>
{% endblock content %}